<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>DeMa-AI</title>
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
		/>
		<!-- Add Chart.js for radar chart -->
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<style>
			:root {
				--primary: #3b82f6;
				--surface: #ffffff;
				--background: #f9fafb;
				--border: #e5e7eb;
				--text: #111827;
				--text-light: #6b7280;
				--sidebar: 320px;
				--navy-dark: #1e3a8a;
				--official-gold: #f59e0b;
				--white: #ffffff;
				--danger: #ef4444;
				--warning: #f59e0b;
				--success: #10b981;
				--info: #3b82f6;
			}

			body {
				margin: 0;
				padding: 0;
				font-family: -apple-system, BlinkMacSystemFont, sans-serif;
				background: var(--background);
				color: var(--text);
				height: 100vh;
				overflow: hidden;
			}

			.container {
				display: flex;
				height: 100vh;
				min-width: 0;
			}

			/* Control Panel - Left - FIXED WIDTH */
			.control-panel {
				width: var(--sidebar);
				min-width: var(--sidebar);
				max-width: var(--sidebar);
				background: var(--surface);
				border-right: 1px solid var(--border);
				display: flex;
				flex-direction: column;
				position: relative;
				flex-shrink: 0;
			}

			/* Logo Header */
			.logo-header {
				padding: 16px 16px 12px 16px;
				border-bottom: 1px solid var(--border);
				display: flex;
				align-items: center;
				gap: 12px;
				background: var(--surface);
				flex-shrink: 0;
			}

			.agency-seal {
				width: 40px;
				height: 40px;
				background: var(--white);
				border-radius: 50%;
				display: flex;
				align-items: center;
				justify-content: center;
				border: 2px solid var(--official-gold);
				flex-shrink: 0;
			}

			.agency-seal i {
				color: var(--navy-dark);
				font-size: 1.2rem;
			}

			.logo-text-container {
				display: flex;
				flex-direction: column;
				min-width: 0;
			}

			.logo-main {
				font-size: 18px;
				font-weight: 800;
				color: var(--navy-dark);
				line-height: 1.1;
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
			}

			.logo-subtitle {
				font-size: 11px;
				font-weight: 500;
				color: var(--text-light);
				letter-spacing: 0.5px;
				margin-top: 2px;
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
			}

			.control-content {
				padding: 16px;
				overflow-y: auto;
				flex: 1;
				min-width: 0;
				/* display: flex; */
				flex-direction: column;
			}

			/* Upload Section */
			.upload-section {
				margin-top: 0;
			}

			.section-title {
				font-size: 13px;
				font-weight: 600;
				margin-bottom: 10px;
				color: var(--text);
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
			}

			.upload-box {
				border: 2px dashed var(--border);
				border-radius: 6px;
				padding: 30px 16px;
				text-align: center;
				cursor: pointer;
				margin-bottom: 16px;
				transition: all 0.3s ease;
				word-wrap: break-word;
				overflow-wrap: break-word;
				position: relative;
			}

			/* Default State */
			.upload-box:hover {
				border-color: var(--primary);
				background: rgba(59, 130, 246, 0.05);
			}

			/* Drag-Over State - SIMPLE HIGHLIGHT */
			.upload-box.dragover {
				border-color: var(--primary);
				background: rgba(59, 130, 246, 0.1);
			}

			/* Uploading State */
			.upload-box.uploading {
				border-color: var(--primary);
			}

			.upload-box.uploading i {
				animation: spin 1s linear infinite;
			}

			/* Invalid State (brief flash) */
			.upload-box.invalid {
				border-color: var(--danger);
				background: rgba(239, 68, 68, 0.05);
			}

			.upload-box i {
				font-size: 28px;
				margin-bottom: 8px;
				transition: all 0.3s ease;
			}

			.upload-box .upload-text {
				font-size: 13px;
				margin-bottom: 4px;
				word-wrap: break-word;
				transition: all 0.3s ease;
			}

			.upload-box .upload-subtext {
				font-size: 10px;
				color: var(--text-light);
				word-wrap: break-word;
				transition: all 0.3s ease;
			}

			/* File Info */
			.file-info {
				background: var(--background);
				padding: 12px;
				border-radius: 6px;
				margin-top: 16px;
				border: 1px solid var(--border);
				display: none;
				word-wrap: break-word;
				overflow-wrap: break-word;
			}

			.file-info.active {
				display: block;
			}

			.file-name {
				font-weight: 600;
				margin-bottom: 4px;
				font-size: 13px;
				overflow: hidden;
				text-overflow: ellipsis;
				white-space: nowrap;
			}

			.file-size {
				font-size: 11px;
				color: var(--text-light);
			}

			/* Results Section */
			.results {
				display: grid;
				grid-template-columns: 1fr 1fr;
				gap: 8px;
				margin-top: 16px;
			}

			.result-box {
				background: var(--background);
				padding: 10px;
				border-radius: 5px;
				text-align: center;
				opacity: 0.6;
				transition: opacity 0.3s;
				min-width: 0;
			}

			.result-box.active {
				opacity: 1;
				box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
			}

			.result-value {
				font-size: 15px;
				font-weight: 600;
				margin: 4px 0;
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
			}

			.result-label {
				font-size: 10px;
				color: var(--text-light);
				text-transform: uppercase;
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
			}

			/* Radar Chart Container */
			.radar-container {
				margin-top: 20px;
				flex: 1;
				display: flex;
				flex-direction: column;
				min-height: 250px;
			}

			.radar-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 10px;
			}

			.radar-title {
				font-size: 13px;
				font-weight: 600;
				color: var(--text);
			}

			.radar-threat-level {
				font-size: 11px;
				font-weight: 600;
				padding: 3px 8px;
				border-radius: 10px;
				background: var(--background);
				border: 1px solid var(--border);
			}

			.radar-threat-level.high {
				background: rgba(239, 68, 68, 0.1);
				color: var(--danger);
				border-color: rgba(239, 68, 68, 0.3);
			}

			.radar-threat-level.medium {
				background: rgba(245, 158, 11, 0.1);
				color: var(--warning);
				border-color: rgba(245, 158, 11, 0.3);
			}

			.radar-threat-level.low {
				background: rgba(16, 185, 129, 0.1);
				color: var(--success);
				border-color: rgba(16, 185, 129, 0.3);
			}

			.radar-chart-wrapper {
				position: relative;
				flex: 1;
				min-height: 200px;
				background: var(--surface);
				border: 1px solid var(--border);
				border-radius: 6px;
				padding: 10px;
			}

			.radar-placeholder {
				display: flex;
				flex-direction: column;
				align-items: center;
				justify-content: center;
				height: 100%;
				color: var(--text-light);
				text-align: center;
				padding: 20px;
			}

			.radar-placeholder i {
				font-size: 32px;
				margin-bottom: 10px;
				color: var(--border);
			}

			.radar-placeholder-text {
				font-size: 11px;
				line-height: 1.4;
			}

			/* Code Panel - Right */
			.code-panel {
				flex: 1;
				display: flex;
				flex-direction: column;
				background: var(--surface);
				min-width: 0;
			}

			/* Code Header with Tab-Button Pairs - FIXED FOR OVERLAPPING */
			.code-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				padding: 0 16px;
				background: var(--surface);
				border-bottom: 1px solid var(--border);
				height: 56px;
				flex-shrink: 0;
				min-width: 0;
			}

			.tab-container {
				display: flex;
				gap: 6px;
				flex: 1;
				min-width: 0;
				overflow-x: auto;
				padding: 2px 0;
			}

			.tab-button-pair {
				display: flex;
				align-items: center;
				border: 1px solid var(--border);
				border-radius: 5px;
				overflow: hidden;
				transition: all 0.2s;
				flex-shrink: 0;
			}

			.tab-button-pair.active {
				border-color: var(--primary);
			}

			.tab-label {
				padding: 5px 10px;
				border: none;
				background: none;
				cursor: pointer;
				color: var(--text-light);
				font-size: 13px;
				display: flex;
				align-items: center;
				gap: 6px;
				transition: all 0.2s;
				white-space: nowrap;
				min-width: 0;
			}

			.tab-button-pair.active .tab-label {
				color: var(--primary);
				background: rgba(59, 130, 246, 0.05);
			}

			.tab-label i {
				font-size: 14px;
				flex-shrink: 0;
			}

			.play-button {
				padding: 10px 12px;
				border: none;
				background: var(--primary);
				color: white;
				cursor: pointer;
				font-size: 12px;
				display: flex;
				align-items: center;
				gap: 4px;
				transition: all 0.2s;
				border-left: 1px solid rgba(255, 255, 255, 0.2);
				flex-shrink: 0;
			}

			.play-button:hover {
				background: #2563eb;
			}

			.play-button i {
				font-size: 12px;
			}

			/* Raw Code tab has no play button */
			.tab-button-pair.raw-code {
				border-radius: 5px;
			}

			.tab-button-pair.raw-code .tab-label {
				border-radius: 5px;
			}

			.utility-buttons {
				display: flex;
				gap: 8px;
				flex-shrink: 0;
				margin-left: 8px;
			}

			.util-btn {
				padding: 8px 12px;
				border: 1px solid var(--border);
				background: var(--surface);
				cursor: pointer;
				color: var(--text);
				border-radius: 5px;
				font-size: 12px;
				display: flex;
				align-items: center;
				gap: 5px;
				transition: all 0.2s;
				flex-shrink: 0;
				white-space: nowrap;
			}

			.util-btn:hover {
				background: var(--background);
			}

			.util-btn.primary {
				background: var(--primary);
				color: white;
				border-color: var(--primary);
			}

			.code-area {
				flex: 1;
				overflow: auto;
				position: relative;
				min-width: 0;
			}

			/* Ghidra Watermark - Only shows when Ghidra tab is active */
			.ghidra-watermark {
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background-image: url("https://media.defense.gov/2019/Apr/04/2002109557/1088/820/0/190404-D-IM742-1002.PNG");
				background-size: 250px 250px;
				background-repeat: no-repeat;
				background-position: center;
				opacity: 0.08;
				pointer-events: none;
				z-index: 0;
				display: none;
			}

			.ghidra-watermark.active {
				display: block;
			}

			.code-display {
				font-family: "Menlo", "Monaco", "Courier New", monospace;
				font-size: 12px;
				line-height: 1.5;
				padding: 16px;
				white-space: pre-wrap;
				word-wrap: break-word;
				overflow-wrap: break-word;
				tab-size: 4;
				min-height: 100%;
				position: relative;
				z-index: 1;
				background: transparent;
			}

			.status-bar {
				background: var(--surface);
				border-top: 1px solid var(--border);
				padding: 8px 16px;
				display: flex;
				justify-content: space-between;
				font-size: 11px;
				color: var(--text-light);
				flex-shrink: 0;
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
			}

			/* Progress Overlay */
			.progress-overlay {
				position: fixed;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background: rgba(0, 0, 0, 0.7);
				display: none;
				align-items: center;
				justify-content: center;
				z-index: 1000;
			}

			.progress-card {
				background: white;
				padding: 24px;
				border-radius: 10px;
				text-align: center;
				min-width: 280px;
				box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
			}

			.progress-text {
				margin-bottom: 12px;
				color: var(--text);
				font-weight: 500;
				font-size: 14px;
			}

			.progress-bar {
				height: 5px;
				background: var(--border);
				border-radius: 3px;
				overflow: hidden;
			}

			.progress-fill {
				height: 100%;
				width: 0%;
				background: linear-gradient(90deg, #3b82f6, #8b5cf6);
				transition: width 0.3s ease;
			}

			/* Modal Overlay */
			.modal-overlay {
				position: fixed;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background: rgba(0, 0, 0, 0.7);
				display: none;
				align-items: center;
				justify-content: center;
				z-index: 2000;
			}

			.modal-content {
				background: white;
				padding: 24px;
				border-radius: 10px;
				max-width: 500px;
				width: 90%;
				max-height: 80vh;
				overflow-y: auto;
				box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
			}

			.modal-title {
				font-size: 18px;
				font-weight: 600;
				margin-bottom: 16px;
				color: var(--danger);
				display: flex;
				align-items: center;
				gap: 8px;
			}

			.modal-body {
				margin-bottom: 20px;
				font-size: 14px;
				line-height: 1.5;
			}

			.modal-actions {
				display: flex;
				justify-content: flex-end;
				gap: 10px;
			}

			.modal-btn {
				padding: 8px 16px;
				border: none;
				border-radius: 5px;
				cursor: pointer;
				font-size: 13px;
			}

			.modal-btn.primary {
				background: var(--primary);
				color: white;
			}

			.modal-btn.secondary {
				background: var(--background);
				color: var(--text);
				border: 1px solid var(--border);
			}

			/* Hide scrollbar for tab container */
			.tab-container::-webkit-scrollbar {
				display: none;
			}

			.tab-container {
				-ms-overflow-style: none;
				scrollbar-width: none;
			}
			.tab-icon {
				width: 18px;
				height: 18px;
				object-fit: contain;
				vertical-align: middle;
				margin-right: 6px;
			}

			/* Threat legend */
			.threat-legend {
				display: flex;
				justify-content: space-between;
				margin-top: 8px;
				font-size: 9px;
			}

			.legend-item {
				display: flex;
				align-items: center;
				gap: 3px;
			}

			.legend-color {
				width: 8px;
				height: 8px;
				border-radius: 50%;
			}

			.legend-color.red {
				background: var(--danger);
			}

			.legend-color.orange {
				background: var(--warning);
			}

			.legend-color.green {
				background: var(--success);
			}

			/* Animations */
			@keyframes spin {
				0% { transform: rotate(0deg); }
				100% { transform: rotate(360deg); }
			}
		</style>
	</head>
	<body>
		<div class="container">
			<!-- Left: Control Panel -->
			<div class="control-panel">
				<!-- Logo Header -->
				<div class="logo-header">
					<div class="agency-seal">
						<i class="fas fa-shield-alt"></i>
					</div>
					<div class="logo-text-container">
						<div class="logo-main">DeMa-AI</div>
						<div class="logo-subtitle">Analysis Platform</div>
					</div>
				</div>

				<div class="control-content">
					<!-- File Upload Area -->
					<div class="upload-section">
						<div class="section-title">Upload File</div>
						<div class="upload-box" id="uploadBox">
							<i class="fas fa-cloud-upload-alt" id="uploadIcon"></i>
							<div class="upload-text" id="uploadText">Drop file here or click to upload</div>
							<div class="upload-subtext" id="uploadSubtext">.bin .exe .o .obj .elf .so .dll</div>
						</div>

						<div class="file-info" id="fileInfo">
							<div class="file-name" id="fileName">No file selected</div>
							<div class="file-size" id="fileSize">—</div>
						</div>
					</div>

					<!-- Results -->
					<div class="section-title">Analysis Results</div>
					<div class="results">
						<div class="result-box" id="resultComplexity">
							<div class="result-label">Complexity</div>
							<div class="result-value">—</div>
						</div>
						<div class="result-box" id="resultThreat">
							<div class="result-label">Threat</div>
							<div class="result-value">—</div>
						</div>
						<div class="result-box" id="resultVulns">
							<div class="result-label">Vulns</div>
							<div class="result-value">—</div>
						</div>
						<div class="result-box" id="resultSize">
							<div class="result-label">Size</div>
							<div class="result-value">—</div>
						</div>
					</div>

					<!-- Radar Chart for Security Threats -->
					<div class="radar-container">
						<div class="radar-header">
							<div class="radar-title">Threat Radar</div>
							<div class="radar-threat-level" id="threatLevel">No Data</div>
						</div>
						<div class="radar-chart-wrapper">
							<canvas id="threatRadar"></canvas>
							<div class="radar-placeholder" id="radarPlaceholder">
								<i class="fas fa-radar"></i>
								<div class="radar-placeholder-text">
									Run security analysis to<br />display threat radar
								</div>
							</div>
						</div>
						<div class="threat-legend">
							<div class="legend-item">
								<div class="legend-color red"></div>
								<span>High Risk</span>
							</div>
							<div class="legend-item">
								<div class="legend-color orange"></div>
								<span>Medium Risk</span>
							</div>
							<div class="legend-item">
								<div class="legend-color green"></div>
								<span>Low Risk</span>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Right: Code Display -->
			<div class="code-panel">
				<!-- Header with Tab-Button Pairs -->
				<div class="code-header">
					<div class="tab-container">
						<!-- Raw Code Display - No Play Button -->
						<div class="tab-button-pair raw-code active" data-view="raw">
							<button class="tab-label" data-action="switch">
								<i class="fas fa-file-code"></i>
								Raw Code
							</button>
						</div>

						<!-- Ghidra Tab-Button Pair -->
						<div class="tab-button-pair" data-view="ghidra">
							<button class="tab-label" data-action="switch">
								<img
									src="https://media.defense.gov/2019/Apr/04/2002109557/1088/820/0/190404-D-IM742-1002.PNG"
									alt="Ghidra"
									class="tab-icon"
								/>
								Ghidra Output
							</button>

							<button class="play-button" data-action="calculate">
								<i class="fas fa-play"></i>
							</button>
						</div>

						<!-- Heuristic Enhanced Tab-Button Pair -->
						<div class="tab-button-pair" data-view="heuristic">
							<button class="tab-label" data-action="switch">
								<i class="fas fa-wand-magic-sparkles"></i>
								Heuristic Enhanced
							</button>
							<button class="play-button" data-action="calculate">
								<i class="fas fa-play"></i>
							</button>
						</div>

						<!-- Security Tab-Button Pair -->
						<div class="tab-button-pair" data-view="security">
							<button class="tab-label" data-action="switch">
								<i class="fas fa-shield-alt"></i>
								Security
							</button>
							<button class="play-button" data-action="calculate">
								<i class="fas fa-play"></i>
							</button>
						</div>
					</div>

					<div class="utility-buttons">
						<button class="util-btn" data-action="copy">
							<i class="fas fa-copy"></i>
							Copy
						</button>
						<button class="util-btn primary" data-action="download">
							<i class="fas fa-download"></i>
							Export
						</button>
					</div>
				</div>

				<div class="code-area">
					<!-- Ghidra Watermark -->
					<div class="ghidra-watermark" id="ghidraWatermark"></div>

					<pre class="code-display" id="codeContent">
// Select a file to begin analysis
// Supported formats: .bin, .exe, .o, .obj, .elf, .so, .dll
//
// Upload a file to see raw binary content
// Other tabs require clicking the play button (▶) to run analysis
                </pre
					>
				</div>

				<div class="status-bar">
					<div id="statusInfo">No file uploaded</div>
					<div id="statusReady">Ready - Raw Code view selected</div>
				</div>
			</div>

			<!-- Progress Overlay -->
			<div class="progress-overlay" id="progressOverlay">
				<div class="progress-card">
					<div class="progress-text" id="progressText">Processing...</div>
					<div class="progress-bar">
						<div class="progress-fill" id="progressFill"></div>
					</div>
				</div>
			</div>

			<!-- Error Modal -->
			<div class="modal-overlay" id="errorModal">
				<div class="modal-content">
					<div class="modal-title">
						<i class="fas fa-exclamation-triangle"></i>
						<span id="modalTitle">Error</span>
					</div>
					<div class="modal-body" id="modalBody">
						Error message will appear here.
					</div>
					<div class="modal-actions">
						<button class="modal-btn secondary" onclick="hideModal()">
							Close
						</button>
						<button class="modal-btn primary" onclick="hideModal()">OK</button>
					</div>
				</div>
			</div>
		</div>

		<script>
			// DOM Elements
			const uploadBox = document.getElementById("uploadBox");
			const uploadIcon = document.getElementById("uploadIcon");
			const uploadText = document.getElementById("uploadText");
			const uploadSubtext = document.getElementById("uploadSubtext");
			const fileInfo = document.getElementById("fileInfo");
			const fileName = document.getElementById("fileName");
			const fileSize = document.getElementById("fileSize");
			const tabButtonPairs = document.querySelectorAll(".tab-button-pair");
			const tabLabels = document.querySelectorAll(".tab-label");
			const playButtons = document.querySelectorAll(".play-button");
			const utilBtns = document.querySelectorAll(".util-btn");
			const resultBoxes = document.querySelectorAll(".result-box");
			const statusInfo = document.getElementById("statusInfo");
			const statusReady = document.getElementById("statusReady");
			const progressOverlay = document.getElementById("progressOverlay");
			const progressFill = document.getElementById("progressFill");
			const progressText = document.getElementById("progressText");
			const codeContent = document.getElementById("codeContent");
			const ghidraWatermark = document.getElementById("ghidraWatermark");
			const threatLevel = document.getElementById("threatLevel");
			const radarPlaceholder = document.getElementById("radarPlaceholder");
			const errorModal = document.getElementById("errorModal");
			const modalTitle = document.getElementById("modalTitle");
			const modalBody = document.getElementById("modalBody");

			// Radar chart variables
			let threatRadarChart = null;
			const radarCanvas = document.getElementById("threatRadar");

			// Current state
			let currentFile = null;
			let currentView = "raw";
			let fileContent = null;
			let decompiledCode = null;
			let enhancedCode = null;
			let securityData = null;
			let languageInfo = null;

			// Security categories (must match backend)
			const SECURITY_CATEGORIES = [
				"DATA_EXFILTRATION",
				"PERSISTENCE",
				"PRIVILEGE_ESCALATION",
				"SURVEILLANCE",
				"DESTRUCTIVE",
				"EVASION",
				"DENIAL_OF_SERVICE",
				"CREDENTIAL_THEFT",
			];

			// Supported file extensions
			const SUPPORTED_EXTENSIONS = ['.bin', '.exe', '.o', '.obj', '.elf', '.so', '.dll'];

			// ==================== DRAG & DROP IMPLEMENTATION ====================

			// Prevent default drag behaviors
			['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
				uploadBox.addEventListener(eventName, preventDefaults, false);
			});

			function preventDefaults(e) {
				e.preventDefault();
				e.stopPropagation();
			}

			// Simple highlight - NO VALIDATION during drag
			['dragenter', 'dragover'].forEach(eventName => {
				uploadBox.addEventListener(eventName, highlight, false);
			});

			['dragleave', 'drop'].forEach(eventName => {
				uploadBox.addEventListener(eventName, unhighlight, false);
			});

			function highlight(e) {
				uploadBox.classList.add('dragover');
				uploadText.textContent = 'Drop to upload';
				uploadSubtext.textContent = 'Release file here';
			}

			function unhighlight(e) {
				uploadBox.classList.remove('dragover');
				uploadText.textContent = 'Drop file here or click to upload';
				uploadSubtext.textContent = '.bin .exe .o .obj .elf .so .dll';
			}

			// Handle dropped files
			uploadBox.addEventListener('drop', handleDrop, false);

			function handleDrop(e) {
				const dt = e.dataTransfer;
				const files = dt.files;
				
				if (files.length > 0) {
					// Take the first file only
					const file = files[0];
					
					// Check if file type is supported (REAL validation here)
					if (isFileTypeSupported(file.name)) {
						// Show uploading state
						uploadBox.classList.add('uploading');
						uploadText.textContent = 'Uploading...';
						uploadSubtext.textContent = 'Processing file';
						uploadIcon.className = 'fas fa-spinner';
						
						// Process immediately
						handleFileUpload(file);
					} else {
						// Show brief error flash
						uploadBox.classList.add('invalid');
						setTimeout(() => {
							uploadBox.classList.remove('invalid');
						}, 1000);
						
						showError(
							"Unsupported File Type",
							`"${file.name}" is not a supported format.\n\nSupported formats: .bin, .exe, .o, .obj, .elf, .so, .dll`
						);
					}
				}
			}

			// Check if file type is supported
			function isFileTypeSupported(filename) {
				if (!filename || filename.indexOf('.') === -1) return false;
				const extension = filename.toLowerCase().substring(filename.lastIndexOf('.'));
				return SUPPORTED_EXTENSIONS.includes(extension);
			}

			// ==================== EVENT LISTENERS ====================

			// Upload box click (existing functionality)
			uploadBox.addEventListener("click", () => {
				const input = document.createElement("input");
				input.type = "file";
				input.accept = ".bin,.exe,.o,.obj,.elf,.so,.dll";

				input.addEventListener("change", (e) => {
					if (e.target.files.length > 0) {
						handleFileUpload(e.target.files[0]);
					}
				});

				input.click();
			});

			// Tab label click - switch view immediately
			tabLabels.forEach((label) => {
				label.addEventListener("click", function () {
					const pair = this.closest(".tab-button-pair");
					const view = pair.dataset.view;

					// Update active tab
					tabButtonPairs.forEach((p) => p.classList.remove("active"));
					pair.classList.add("active");
					currentView = view;

					// Show/hide watermark for Ghidra view
					if (view === "ghidra" || view === "heuristic") {
						ghidraWatermark.classList.add("active");
					} else {
						ghidraWatermark.classList.remove("active");
					}

					// Show the view content immediately
					showView(view);
				});
			});

			// Play button click - run calculation for that specific view
			playButtons.forEach((button) => {
				button.addEventListener("click", function () {
					if (!currentFile) {
						showError(
							"File Required",
							"Please upload a file first to run analysis"
						);
						return;
					}

					const pair = this.closest(".tab-button-pair");
					const view = pair.dataset.view;

					// Run calculation for this specific view
					performCalculation(view);
				});
			});

			// Utility button actions
			utilBtns.forEach((btn) => {
				btn.addEventListener("click", function () {
					const action = this.dataset.action;

					if (action === "copy") {
						navigator.clipboard.writeText(codeContent.textContent);
						showNotification("Code copied to clipboard");
					} else if (action === "download") {
						if (!currentFile) {
							showError("No File", "Please upload a file first");
							return;
						}
						exportCurrentView();
					}
				});
			});

			// ==================== FILE HANDLING ====================

			// Handle file upload
			function handleFileUpload(file) {
				// Validate file type before proceeding
				if (!isFileTypeSupported(file.name)) {
					showError(
						"Unsupported File Type",
						`"${file.name}" is not a supported format.\n\nSupported formats: .bin, .exe, .o, .obj, .elf, .so, .dll`
					);
					return; // Exit without processing
				}
				
				currentFile = file;

				// Update file info
				fileName.textContent = file.name;
				fileSize.textContent = formatFileSize(file.size);
				fileInfo.classList.add("active");

				// Update status
				statusInfo.textContent = `File: ${file.name} (${formatFileSize(
					file.size
				)})`;

				// Show processing
				showProgress("Uploading file...", 1000, () => {
					// Read file content for raw view
					const reader = new FileReader();
					reader.onload = function (e) {
						fileContent = e.target.result;

						// Reset results
						resultBoxes.forEach((box) => {
							box.classList.remove("active");
							box.querySelector(".result-value").textContent = "—";
						});

						// Reset radar
						resetRadar();

						// Reset stored data
						decompiledCode = null;
						enhancedCode = null;
						securityData = null;
						languageInfo = null;

						// Automatically run language classification
						classifyLanguage(file);

						// Show raw content
						showView("raw");

						showNotification(
							"File uploaded successfully. Language classification in progress."
						);
						
						// Reset upload box UI
						uploadBox.classList.remove('uploading');
						uploadText.textContent = 'Drop file here or click to upload';
						uploadSubtext.textContent = '.bin .exe .o .obj .elf .so .dll';
						uploadIcon.className = 'fas fa-cloud-upload-alt';
					};

					if (file.name.endsWith(".o") || file.name.endsWith(".obj")) {
						reader.readAsText(file);
					} else {
						reader.readAsArrayBuffer(file);
					}
				});
			}

			// ==================== API INTEGRATION ====================

			// Classify language automatically
			async function classifyLanguage(file) {
				const formData = new FormData();
				formData.append("file", file);

				try {
					const response = await fetch("/classify", {
						method: "POST",
						body: formData,
					});

					if (!response.ok) {
						throw new Error(`Classification failed: ${response.status}`);
					}

					const data = await response.json();
					languageInfo = data;

					if (data.language && data.language !== "Unknown") {
						statusInfo.textContent = `File: ${file.name} | Language: ${
							data.language
						} (${Math.round(data.confidence * 100)}% confidence)`;
						showNotification(
							`Language detected: ${data.language} with ${Math.round(
								data.confidence * 100
							)}% confidence`
						);
					}
				} catch (error) {
					console.log("Language classification failed:", error);
				}
			}

			// Perform calculation for a view
			async function performCalculation(view) {
				if (!currentFile) {
					showError("No File", "Please upload a file first");
					return;
				}

				const endpoints = {
					ghidra: "/ghidra_decompile",
					heuristic: "/ghidra_enhance",
					security: "/security_analyze",
				};

				const endpoint = endpoints[view];
				if (!endpoint) {
					showError("Invalid View", "This view is not supported");
					return;
				}

				// Check if we need Ghidra output for security analysis
				if (view === "security") {
					const hasGhidra = await checkGhidraOutput();
					if (!hasGhidra) {
						showError(
							"No Decompiled Code",
							"Please run Ghidra decompilation first before security analysis"
						);
						return;
					}

					showProgress("Running security analysis...", 0);

					try {
						const response = await fetch(endpoint, {
							method: "POST",
						});

						const result = await response.json();

						if (!response.ok) {
							throw new Error(
								result.error || `Server returned ${response.status}`
							);
						}

						securityData = result;
						showProgress("Processing security analysis...", 1000, () => {
							displaySecurityResult(result);
							updateRadarFromSecurity(result);
							updateResultsFromSecurity(result);
							showNotification("Security analysis completed successfully");
						});
					} catch (error) {
						hideProgress();
						showError(
							"Security Analysis Failed",
							error.message || "An error occurred during security analysis"
						);
						console.error("Security analysis error:", error);
					}

					return;
				}

				// For Ghidra decompilation/enhancement
				const formData = new FormData();
				formData.append("file", currentFile);

				showProgress(
					`Running ${
						view === "ghidra" ? "Ghidra decompilation" : "heuristic enhancement"
					}...`,
					0
				);

				try {
					const response = await fetch(endpoint, {
						method: "POST",
						body: formData,
					});

					const result = await response.json();

					if (!response.ok) {
						throw new Error(
							result.error || `Server returned ${response.status}`
						);
					}

					// Process based on view
					if (view === "ghidra") {
						decompiledCode = result.decompiled_code;
						showProgress("Processing Ghidra output...", 1000, () => {
							displayGhidraResult(result);
							showNotification("Ghidra decompilation completed successfully");
						});
					} else if (view === "heuristic") {
						enhancedCode = result.decompiled_code;
						showProgress("Processing enhanced output...", 1000, () => {
							displayEnhancedResult(result);
							showNotification("Heuristic enhancement completed successfully");
						});
					}
				} catch (error) {
					hideProgress();
					showError(
						"Analysis Failed",
						error.message || "An error occurred during analysis"
					);
					console.error(`${view} analysis error:`, error);
				}
			}

			// Check if Ghidra output exists
			async function checkGhidraOutput() {
				try {
					const response = await fetch("/get_current_file");
					const data = await response.json();
					return data.exists === true;
				} catch (error) {
					return false;
				}
			}

			// ==================== DISPLAY FUNCTIONS ====================

			// Show specific view
			function showView(view) {
				ghidraWatermark.classList.remove("active");

				switch (view) {
					case "raw":
						if (fileContent && currentFile) {
							codeContent.textContent = getRawContentView();
							statusReady.textContent = "Raw Code view - File content displayed";
						} else {
							codeContent.textContent = getRawView();
							statusReady.textContent = "Raw Code view - No file uploaded";
						}
						break;
					case "ghidra":
						ghidraWatermark.classList.add("active");

						if (decompiledCode) {
							codeContent.textContent = decompiledCode;
							statusReady.textContent = "Ghidra Output view - Decompilation complete";
						} else if (currentFile) {
							codeContent.textContent = getGhidraView();
							statusReady.textContent = "Ghidra Output view - Ready for analysis";
						} else {
							codeContent.textContent = getGhidraView();
							statusReady.textContent = "Ghidra Output view - Upload a file first";
						}
						break;
					case "heuristic":
						ghidraWatermark.classList.add("active");

						if (enhancedCode) {
							codeContent.textContent = enhancedCode;
							statusReady.textContent = "Heuristic Enhanced view - Enhancement complete";
						} else if (currentFile) {
							codeContent.textContent = getHeuristicView();
							statusReady.textContent = "Heuristic Enhanced view - Ready for analysis";
						} else {
							codeContent.textContent = getHeuristicView();
							statusReady.textContent = "Heuristic Enhanced view - Upload a file first";
						}
						break;
					case "security":
						if (securityData) {
							displaySecurityResult(securityData);
							statusReady.textContent = "Security view - Analysis complete";
						} else if (currentFile) {
							codeContent.textContent = getSecurityView();
							statusReady.textContent = "Security view - Ready for analysis";
						} else {
							codeContent.textContent = getSecurityView();
							statusReady.textContent = "Security view - Upload a file first";
						}
						break;
				}
			}

			// Display Ghidra result
			function displayGhidraResult(result) {
				codeContent.textContent = `/* Ghidra Decompilation Output */
/* File: ${currentFile.name} */
/* Analysis Time: ${result.ghidra_time}s */

${result.decompiled_code}`;

				statusReady.textContent = "Ghidra decompilation complete - Ready for further analysis";

				updateResults({
					complexity: "Calculating...",
					threat: "Pending",
					vulns: "Pending",
					size: formatFileSize(currentFile.size),
				});
			}

			// Display enhanced result
			function displayEnhancedResult(result) {
				codeContent.textContent = `/* Heuristic Enhanced Decompilation */
/* File: ${currentFile.name} */
/* Ghidra Time: ${result.ghidra_time}s | Enhancement Time: ${result.enhancement_time}s */
/* Enhancement Status: ${result.enhancement_status} */

${result.decompiled_code}`;

				statusReady.textContent = "Heuristic enhancement complete - Ready for security analysis";

				updateResults({
					complexity: "Enhanced",
					threat: "Pending",
					vulns: "Pending",
					size: formatFileSize(currentFile.size),
				});
			}

			// Display security result
			function displaySecurityResult(result) {
				const metrics = result.security_metrics?.metrics || {};
				const radar = result.security_metrics?.radar_data || {};
				
				let securityReport = `/* Security Analysis Report */
/* File: ${result.file_analyzed || currentFile.name} */
/* Analysis Time: ${new Date().toLocaleString()} */

SUMMARY:
========
• Total Functions Analyzed: ${metrics.total_functions || 0}
• Malicious Functions: ${metrics.malicious_functions || 0}
• Benign Functions: ${(metrics.total_functions || 0) - (metrics.malicious_functions || 0)}

DETAILED FINDINGS:
==================`;

				if (result.json_report?.functions) {
					const allFunctions = result.json_report.functions;
					
					allFunctions.forEach((func, index) => {
						const isMalicious = func.classification?.malicious === true;
						
						securityReport += `\n\n${index + 1}. ${func.function}`;
						securityReport += `\n   Status: ${isMalicious ? 'MALICIOUS' : 'BENIGN'}`;
						securityReport += `\n   Confidence: ${Math.round((func.classification?.confidence || 0) * 100)}%`;
						securityReport += `\n   Explanation: ${func.classification?.explanation || 'No explanation provided'}`;
						
						const behaviors = func.classification?.behavioral_actions || [];
						if (behaviors.length > 0) {
							securityReport += `\n   Detected Behaviors:`;
							behaviors.forEach(action => {
								securityReport += `\n     - ${action.behavior}: ${action.apis?.join(', ') || 'No APIs'} (${action.reason || 'No reason'})`;
							});
						}
						
						const triggers = func.signals?.triggers || [];
						if (triggers.length > 0) {
							securityReport += `\n   Security Signals:`;
							triggers.forEach(trigger => {
								if (trigger.type === 'api_category') {
									securityReport += `\n     - ${trigger.category}: ${trigger.count || 1} occurrence(s)`;
								}
							});
						}
						
						const raw_counts = func.signals?.raw_counts || {};
						if (Object.keys(raw_counts).length > 0) {
							securityReport += `\n   Raw Counts:`;
							for (const [key, value] of Object.entries(raw_counts)) {
								if (value > 0) {
									securityReport += `\n     - ${key}: ${value}`;
								}
							}
						}
					});
				}

				codeContent.textContent = securityReport;
				statusReady.textContent = "Security analysis complete - Threat radar updated";
			}

			// Update radar from security data
			function updateRadarFromSecurity(result) {
				const radarData = result.security_metrics?.radar_data;
				if (!radarData || !radarData.data || radarData.data.length === 0) {
					resetRadar();
					return;
				}

				updateRadar({
					labels: radarData.labels || SECURITY_CATEGORIES,
					data: radarData.data,
					threatLevel: radarData.threat_level || "unknown",
				});
			}

			// Update results from security data
			function updateResultsFromSecurity(result) {
				const metrics = result.security_metrics?.metrics;
				if (!metrics) return;

				updateResults({
					complexity: metrics.complexity || "Unknown",
					threat: `${metrics.threat_percentage || 0}%`,
					vulns: metrics.malicious_functions || 0,
					size: formatFileSize(currentFile.size),
				});
			}

			// ==================== RADAR CHART FUNCTIONS ====================

			// Update radar chart
			function updateRadar(radarData) {
				radarPlaceholder.style.display = "none";

				if (threatRadarChart) {
					threatRadarChart.destroy();
				}

				threatLevel.textContent = radarData.threatLevel.charAt(0).toUpperCase() + radarData.threatLevel.slice(1);
				threatLevel.className = "radar-threat-level " + radarData.threatLevel;

				const avgScore = radarData.data.reduce((a, b) => a + b, 0) / radarData.data.length;
				let threatColor;
				if (avgScore > 70) {
					threatColor = "#ef4444";
				} else if (avgScore > 30) {
					threatColor = "#f59e0b";
				} else {
					threatColor = "#10b981";
				}

				threatRadarChart = new Chart(radarCanvas, {
					type: "radar",
					data: {
						labels: radarData.labels,
						datasets: [
							{
								label: "Threat Level",
								data: radarData.data,
								backgroundColor: "rgba(59, 130, 246, 0.2)",
								borderColor: threatColor,
								borderWidth: 2,
								pointBackgroundColor: threatColor,
								pointBorderColor: "#fff",
								pointBorderWidth: 1,
								pointRadius: 3,
							},
						],
					},
					options: {
						responsive: true,
						maintainAspectRatio: false,
						plugins: { legend: { display: false } },
						scales: {
							r: {
								angleLines: { color: "rgba(0, 0, 0, 0.1)" },
								grid: { color: "rgba(0, 0, 0, 0.1)" },
								pointLabels: { font: { size: 9 }, color: "var(--text-light)" },
								ticks: { display: false, maxTicksLimit: 5, beginAtZero: true, max: 100 },
								min: 0,
								max: 100,
							},
						},
						elements: { line: { tension: 0.4 } },
					},
				});
			}

			// Reset radar to placeholder state
			function resetRadar() {
				if (threatRadarChart) {
					threatRadarChart.destroy();
					threatRadarChart = null;
				}
				radarPlaceholder.style.display = "flex";
				threatLevel.textContent = "No Data";
				threatLevel.className = "radar-threat-level";
			}

			// ==================== HELPER FUNCTIONS ====================

			// Update results panel
			function updateResults(results) {
				document.getElementById("resultComplexity").querySelector(".result-value").textContent = results.complexity;
				document.getElementById("resultThreat").querySelector(".result-value").textContent = results.threat;
				document.getElementById("resultVulns").querySelector(".result-value").textContent = results.vulns;
				document.getElementById("resultSize").querySelector(".result-value").textContent = results.size;

				resultBoxes.forEach((box) => box.classList.add("active"));
			}

			// Export current view
			function exportCurrentView() {
				const blob = new Blob([codeContent.textContent], { type: "text/plain" });
				const url = URL.createObjectURL(blob);
				const a = document.createElement("a");
				a.href = url;

				let filename = currentFile.name.replace(/\.[^/.]+$/, "");
				if (currentView === "ghidra") filename += "_ghidra";
				else if (currentView === "heuristic") filename += "_enhanced";
				else if (currentView === "security") filename += "_security";
				else filename += "_raw";
				filename += ".txt";

				a.download = filename;
				a.click();
				showNotification(`Exported as ${filename}`);
			}

			// Show progress animation
			function showProgress(text, duration, callback) {
				progressText.textContent = text;
				progressOverlay.style.display = "flex";
				progressFill.style.width = "0%";

				if (duration === 0) {
					progressFill.style.width = "30%";
					progressFill.style.animation = "pulse 2s infinite";
					return;
				}

				let progress = 0;
				const interval = setInterval(() => {
					progress += 2;
					progressFill.style.width = `${progress}%`;

					if (progress >= 100) {
						clearInterval(interval);
						setTimeout(() => {
							progressOverlay.style.display = "none";
							progressFill.style.width = "0%";
							progressFill.style.animation = "none";
							if (callback) callback();
						}, 500);
					}
				}, duration / 50);
			}

			// Hide progress
			function hideProgress() {
				progressOverlay.style.display = "none";
				progressFill.style.width = "0%";
				progressFill.style.animation = "none";
			}

			// Show error modal
			function showError(title, message) {
				modalTitle.textContent = title;
				modalBody.textContent = message;
				errorModal.style.display = "flex";
			}

			// Hide modal
			function hideModal() {
				errorModal.style.display = "none";
			}

			// Show notification
			function showNotification(message) {
				const notification = document.createElement("div");
				notification.textContent = message;
				notification.style.cssText = `
					position: fixed;
					top: 20px;
					right: 20px;
					background: #10b981;
					color: white;
					padding: 10px 16px;
					border-radius: 5px;
					box-shadow: 0 4px 12px rgba(0,0,0,0.15);
					z-index: 1001;
					font-size: 13px;
				`;
				document.body.appendChild(notification);

				setTimeout(() => notification.remove(), 3000);
			}

			// Get raw content view
			function getRawContentView() {
				if (!currentFile || !fileContent) return "No file content available";

				if (currentFile.name.endsWith(".o") || currentFile.name.endsWith(".obj")) {
					return `Raw File Content - ${currentFile.name}
Size: ${formatFileSize(currentFile.size)}
Format: Object File

${fileContent}`;
				} else {
					let hexView = `Raw Binary Content - ${currentFile.name}
Size: ${formatFileSize(currentFile.size)}
Format: Binary/Executable

Hex Dump (first 1024 bytes):\n`;

					if (fileContent instanceof ArrayBuffer) {
						const bytes = new Uint8Array(fileContent.slice(0, 1024));
						for (let i = 0; i < bytes.length; i += 16) {
							let hex = "";
							let ascii = "";
							for (let j = 0; j < 16; j++) {
								if (i + j < bytes.length) {
									const byte = bytes[i + j];
									hex += byte.toString(16).padStart(2, "0") + " ";
									ascii += byte >= 32 && byte <= 126 ? String.fromCharCode(byte) : ".";
								} else {
									hex += "   ";
								}
							}
							hexView += `${i.toString(16).padStart(8, "0")}: ${hex} ${ascii}\n`;
						}
						if (currentFile.size > 1024) {
							hexView += `\n... (${currentFile.size - 1024} more bytes truncated)`;
						}
					}

					return hexView;
				}
			}

			// View content functions (initial views)
			function getRawView() {
				return "Upload a file to see raw content\n\nSupported formats: .bin, .exe, .o, .obj, .elf, .so, .dll\n\nOnce uploaded, raw file content will be displayed here automatically.";
			}

			function getGhidraView() {
				return `Ghidra Output View - Ready for Analysis
File: ${currentFile ? currentFile.name : "No file"}
Size: ${currentFile ? formatFileSize(currentFile.size) : "—"}

Click the play button (▶) to run Ghidra decompilation.

Note: Ghidra analysis may take 30-60 seconds for large files.`;
			}

			function getHeuristicView() {
				return `Heuristic Enhanced View - Ready for Analysis
File: ${currentFile ? currentFile.name : "No file"}
Size: ${currentFile ? formatFileSize(currentFile.size) : "—"}

Click the play button (▶) to run heuristic enhancement.

Note: Requires Ghidra decompilation first.`;
			}

			function getSecurityView() {
				return `Security View - Ready for Analysis
File: ${currentFile ? currentFile.name : "No file"}
Size: ${currentFile ? formatFileSize(currentFile.size) : "—"}

Click the play button (▶) to run security scan.

Note: Requires Ghidra decompilation first.`;
			}

			// Helper functions
			function formatFileSize(bytes) {
				if (bytes === 0) return "0 Bytes";
				const k = 1024;
				const sizes = ["Bytes", "KB", "MB", "GB"];
				const i = Math.floor(Math.log(bytes) / Math.log(k));
				return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
			}

			// Initialize
			document.addEventListener("DOMContentLoaded", () => {
				console.log("DeMa-AI Analysis Platform loaded with simplified drag & drop");
			});
		</script>
	</body>
</html>